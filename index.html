<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=760">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
	
	

    <title>Five9 UAT Tool</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
 
	<link rel="stylesheet" type="text/css" href="css/custom.css" />











</head>
<body>
	<div class="modal fade modal-dialog modal-dialog-scrollable" id="myModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
	  <div class="modal-dialog modal-xl">
		<div class="modal-content">
		  <div class="modal-header">
			<h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
			<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		  </div>
		  <div class="modal-body">
			<pre id="json-display"></pre>

		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
			<button type="button" class="btn btn-primary">Save changes</button>
		  </div>
		</div>
	  </div>
	</div>
	
	
	
	<header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
	  <a class="navbar-brand col-md-2 col-lg-2 me-0 px-3" href="#">Company name</a>
	  <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
		<span class="navbar-toggler-icon"></span>
	  </button>
	  <input class="form-control form-control-dark   " name="ani" id="ani" title="This is the number for the device you are calling from, not the number you are dialing to." type="text" placeholder="Your phone number" aria-label="Search">
	  <div class="navbar-nav col-md-2 col-lg-2">
		<div class="nav-item text-nowrap">
		  <button class="btn btn-dark px-3" onclick="assignANI()" >Assign ANI</button>
		</div>
	  </div>
	</header>

	<div class="row">
		<!--sidebar-->
		<div id="sidebarMenu" class="col-md-2 col-lg-2 d-md-block bg-light sidebar collapse">
			<div class="bg-danger text-white mx-auto text-center" >
				<div id="listening">Not Listening to any ANI</div>
			</div>
			<div id = "debugmenu" class = "collapse">
				<h6>Debug Menu</h6>
				<div class="form-group">
					<label for="testPayload">Payload</label>
					<textarea type="email" class="form-control" id="testPayload" aria-describedby="testPayloadHelp" placeholder="Enter email">
						[{"cust_name":"AMERICA","group_id":268,"instance_id":38445,"node_id":"3643693","node_name":"Disconnect","node_type":"disconnect","node_values":{"task_name":"Orelup UAT Test","XSIP_via":"SIP\/2.0\/UDP 199.189.191.98:5188;branch=z9hG4bK5f05.c0ece73.0;i=4713fb11","XSIP_from":"<sip:2195521234@208.69.29.36>;tag=gK0c11f605","XSIP_to":"<sip:777112899917@199.189.191.98>","XSIP_call_id":"460073133_128831108@208.69.29.36","XSIP_cseq":"268403 INVITE","XSIP_max_forwards":"68","XSIP_allow":"INVITE,ACK,CANCEL,BYE,REGISTER,REFER,INFO,SUBSCRIBE,NOTIFY,PRACK,UPDATE,OPTIONS,MESSAGE,PUBLISH","XSIP_accept":"application\/sdp, application\/isup, application\/dtmf, application\/dtmf-relay, multipart\/mixed","XSIP_contact":"<sip:199.189.191.98:5188;did=579.839b79e5>","XSIP_p_asserted_identity":"<sip:2195521234@208.69.29.36:5061>","XSIP_allow_events":"talk, hold, conference, presence, as-feature-event, dialog, line-seize, call-info, sla, include-session-description, presence.winfo, message-summary, refer","XSIP_five9_sbc_info":"call;tenant_id=127763;participant_id=300000000007260","XSIP_five9_info":"ITSP-call;grp=pvt_trk_inference_studio7","XSIP_x_five9dnis":"8558195944","XSIP_x_five9ani":"2195521234","XSIP_x_five9callid":"300000000001308","XSIP_x_five9sessionid":"C52F146F28234EFDBE74ACC30B00D9D3","XSIP_x_uui":"true","XSIP_x_fs_support":"update_display,send_info","XSIP_p_origination_id":"127763","XSIP_supported":"timer,100rel,precondition,replaces","XSIP_session_expires":"1800","XSIP_min_se":"90","XSIP_content_length":"494","XSIP_content_disposition":"session; handling=required","XSIP_content_type":"application\/sdp"},"timestamp":"1670618626135","uuid":"395072d4-7b53-42b4-9be8-d5eb8c8b5035","node_order":7,"time_taken":"0.001s"},{"cust_name":"AMERICA","group_id":268,"instance_id":38445,"node_id":"3643719","node_name":"Set Call Hangup","node_type":"variable","node_values":{"vcc_routeType":"Hangup","task_name":"Orelup UAT Test","XSIP_via":"SIP\/2.0\/UDP 199.189.191.98:5188;branch=z9hG4bK5f05.c0ece73.0;i=4713fb11","XSIP_from":"<sip:2195521234@208.69.29.36>;tag=gK0c11f605","XSIP_to":"<sip:777112899917@199.189.191.98>","XSIP_call_id":"460073133_128831108@208.69.29.36","XSIP_cseq":"268403 INVITE","XSIP_max_forwards":"68","XSIP_allow":"INVITE,ACK,CANCEL,BYE,REGISTER,REFER,INFO,SUBSCRIBE,NOTIFY,PRACK,UPDATE,OPTIONS,MESSAGE,PUBLISH","XSIP_accept":"application\/sdp, application\/isup, application\/dtmf, application\/dtmf-relay, multipart\/mixed","XSIP_contact":"<sip:199.189.191.98:5188;did=579.839b79e5>","XSIP_p_asserted_identity":"<sip:2195521234@208.69.29.36:5061>","XSIP_allow_events":"talk, hold, conference, presence, as-feature-event, dialog, line-seize, call-info, sla, include-session-description, presence.winfo, message-summary, refer","XSIP_five9_sbc_info":"call;tenant_id=127763;participant_id=300000000007260","XSIP_five9_info":"ITSP-call;grp=pvt_trk_inference_studio7","XSIP_x_five9dnis":"8558195944","XSIP_x_five9ani":"2195521234","XSIP_x_five9callid":"300000000001308","XSIP_x_five9sessionid":"C52F146F28234EFDBE74ACC30B00D9D3","XSIP_x_uui":"true","XSIP_x_fs_support":"update_display,send_info","XSIP_p_origination_id":"127763","XSIP_supported":"timer,100rel,precondition,replaces","XSIP_session_expires":"1800","XSIP_min_se":"90","XSIP_content_length":"494","XSIP_content_disposition":"session; handling=required","XSIP_content_type":"application\/sdp"},"timestamp":"1670618626135","uuid":"395072d4-7b53-42b4-9be8-d5eb8c8b5035","node_order":8,"time_taken":"0s"},{"cust_name":"AMERICA","group_id":268,"instance_id":38445,"node_id":"3643721","node_name":"Go Write Session Data","node_type":"goto","node_values":{"next_node_id":3643723,"task_name":"Orelup UAT Test","XSIP_via":"SIP\/2.0\/UDP 199.189.191.98:5188;branch=z9hG4bK5f05.c0ece73.0;i=4713fb11","XSIP_from":"<sip:2195521234@208.69.29.36>;tag=gK0c11f605","XSIP_to":"<sip:777112899917@199.189.191.98>","XSIP_call_id":"460073133_128831108@208.69.29.36","XSIP_cseq":"268403 INVITE","XSIP_max_forwards":"68","XSIP_allow":"INVITE,ACK,CANCEL,BYE,REGISTER,REFER,INFO,SUBSCRIBE,NOTIFY,PRACK,UPDATE,OPTIONS,MESSAGE,PUBLISH","XSIP_accept":"application\/sdp, application\/isup, application\/dtmf, application\/dtmf-relay, multipart\/mixed","XSIP_contact":"<sip:199.189.191.98:5188;did=579.839b79e5>","XSIP_p_asserted_identity":"<sip:2195521234@208.69.29.36:5061>","XSIP_allow_events":"talk, hold, conference, presence, as-feature-event, dialog, line-seize, call-info, sla, include-session-description, presence.winfo, message-summary, refer","XSIP_five9_sbc_info":"call;tenant_id=127763;participant_id=300000000007260","XSIP_five9_info":"ITSP-call;grp=pvt_trk_inference_studio7","XSIP_x_five9dnis":"8558195944","XSIP_x_five9ani":"2195521234","XSIP_x_five9callid":"300000000001308","XSIP_x_five9sessionid":"C52F146F28234EFDBE74ACC30B00D9D3","XSIP_x_uui":"true","XSIP_x_fs_support":"update_display,send_info","XSIP_p_origination_id":"127763","XSIP_supported":"timer,100rel,precondition,replaces","XSIP_session_expires":"1800","XSIP_min_se":"90","XSIP_content_length":"494","XSIP_content_disposition":"session; handling=required","XSIP_content_type":"application\/sdp"},"timestamp":"1670618626136","uuid":"395072d4-7b53-42b4-9be8-d5eb8c8b5035","node_order":9,"time_taken":"0.001s"},{"cust_name":"AMERICA","group_id":268,"instance_id":38445,"node_id":"3643723","node_name":"Write Session Data","node_type":"data_store","node_values":{"form_data":{"data_store_id":20685,"query_condition":[],"row_limit":1,"order_by":{"column":"","sortBy":""},"document_id":"","operation_name":"insert","document_rules":{"vcc_call_id":"300000000001308","ani":"2195521234","iisn":"777112899917","accountid":"268","region":"AMERICA","pop":"VIR","vcc_ani":"2195521234","vcc_dnis":"8558195944","vcc_sessionid":"C52F146F28234EFDBE74ACC30B00D9D3","routetype":"Hangup","routevalue":"EMPTY","routereason":"EMPTY","_task_id":38445,"_uuid":"395072d4-7b53-42b4-9be8-d5eb8c8b5035","_timestamp":"1670618626137"}},"api_response":{"response_code":200,"response":"Data Inserted","succeeded":1,"failed":0,"ignored":0,"additional_info":{"_id":["63939e02a76d2b0e4a0099b9"]}},"new_row_id":{"row_id":"63939e02a76d2b0e4a0099b9"},"task_name":"Orelup UAT Test","XSIP_via":"SIP\/2.0\/UDP 199.189.191.98:5188;branch=z9hG4bK5f05.c0ece73.0;i=4713fb11","XSIP_from":"<sip:2195521234@208.69.29.36>;tag=gK0c11f605","XSIP_to":"<sip:777112899917@199.189.191.98>","XSIP_call_id":"460073133_128831108@208.69.29.36","XSIP_cseq":"268403 INVITE","XSIP_max_forwards":"68","XSIP_allow":"INVITE,ACK,CANCEL,BYE,REGISTER,REFER,INFO,SUBSCRIBE,NOTIFY,PRACK,UPDATE,OPTIONS,MESSAGE,PUBLISH","XSIP_accept":"application\/sdp, application\/isup, application\/dtmf, application\/dtmf-relay, multipart\/mixed","XSIP_contact":"<sip:199.189.191.98:5188;did=579.839b79e5>","XSIP_p_asserted_identity":"<sip:2195521234@208.69.29.36:5061>","XSIP_allow_events":"talk, hold, conference, presence, as-feature-event, dialog, line-seize, call-info, sla, include-session-description, presence.winfo, message-summary, refer","XSIP_five9_sbc_info":"call;tenant_id=127763;participant_id=300000000007260","XSIP_five9_info":"ITSP-call;grp=pvt_trk_inference_studio7","XSIP_x_five9dnis":"8558195944","XSIP_x_five9ani":"2195521234","XSIP_x_five9callid":"300000000001308","XSIP_x_five9sessionid":"C52F146F28234EFDBE74ACC30B00D9D3","XSIP_x_uui":"true","XSIP_x_fs_support":"update_display,send_info","XSIP_p_origination_id":"127763","XSIP_supported":"timer,100rel,precondition,replaces","XSIP_session_expires":"1800","XSIP_min_se":"90","XSIP_content_length":"494","XSIP_content_disposition":"session; handling=required","XSIP_content_type":"application\/sdp"},"timestamp":"1670618626209","uuid":"395072d4-7b53-42b4-9be8-d5eb8c8b5035","node_order":10,"time_taken":"0.073s"}]
					</textarea>
					<small id="testPayloadHelp" class="form-text text-muted">Paste a submission node here.</small>
					<button onclick="debugMessage()" >submit</button>
				</div>
			</div>
		</div>
		
		<!--main table-->
		<main class="col-md-8 ms-sm-auto me-sm-auto col-lg-8 px-md-4">
			<div>
						
						
					
					<table id="logs" class="table" table-striped>
						<tr>
							<th>Time</th>
							<th>CallID</th>
							<th>UUID</th>
							<th>name</th>
							<th>Submit</th>
							</tr>
						<tbody>
						</tbody>
					</table>
			</div>
		</main>
		<div  class="col-md-2 col-lg-2 d-md-block bg-light asside collapse">
		</div>
	</div>
		
		
		
		
		
		
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js" integrity="sha384-/KNQL8Nu5gCHLqwqfQjA689Hhoqgi2S84SNUxC3roTe4EhJ9AfLkp8QiQcU8AMzI" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
<script src="js/jquery.json-editor.min.js" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js" integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V" crossorigin="anonymous"></script>
<script>
function GetURLParameter(sParam) {
    var sPageURL = window.location.search.substring(1);
    var sURLVariables = sPageURL.split('&');
    for (var i = 0; i < sURLVariables.length; i++) 
    {
        var sParameterName = sURLVariables[i].split('=');
        if (sParameterName[0] == sParam) 
        {
            return sParameterName[1];
        }
    }
	return "null";
}
function timeConverter(UNIX_timestamp){
  var a = new Date(UNIX_timestamp*1);
  return a.toLocaleString('en-US', {
    timeZone: 'America/New_York',
	timeZoneName: 'short'
  });
}
const fullLog = GetURLParameter("fullLog");
const project = GetURLParameter("project");
const debugmenu = document.getElementById('debugmenu');
const ani = document.getElementById('ani');
const logs = document.getElementById('logs');
const listening = document.getElementById('listening');
var myModal = new bootstrap.Modal(document.getElementById('myModal'), {
  keyboard: false
});
var jsonObject = {};
var editor =new JsonEditor('#json-display', getJson());



var oldvalue = "";
var records = {};

if(GetURLParameter("debug") != "null")
{
	new bootstrap.Collapse(debugmenu);
}


function loopLogItem(msg) {
  console.log(msg);
  var callID = (!msg.node_values.XSIP_x_five9callid ) ? "" : msg.node_values.XSIP_x_five9callid;
  var uuid = (!msg.uuid ) ? "" : msg.uuid;
  var node_order = (!msg.node_order) ? "" : msg.node_order;
  if(node_order != "")
  {
	records[callID+uuid][msg.node_order] = msg;
  }else
  {
	records[callID+uuid][Object.keys(records[callID+uuid]).length]= msg;
  }
}

function logMessage(msg)
{
	console.log("Call Information Recieved");
	console.log(msg);
	var callID = (!msg[0].node_values.XSIP_x_five9callid ) ? "" : msg[0].node_values.XSIP_x_five9callid;
	var uuid = (!msg[0].uuid ) ? "" : msg[0].uuid;
	
	if(callID == "" && uuid == "")
	{
		console.log("Invalid call recieved");
		return;
	}
	if (callID+uuid in records)
	{
		msg.forEach(loopLogItem);
		console.log("Call Update");
		return;
	}
	else
	{
		records[callID+uuid] = {};
		msg.forEach(loopLogItem);
	}
	var uniqueID = callID+uuid;
	var row = logs.insertRow();
	var cell1 = row.insertCell(0);
	var cell2 = row.insertCell(1);
	var cell3 = row.insertCell(2);
	var cell4 = row.insertCell(3);
	var cell5 = row.insertCell(4);
	cell1.innerHTML = timeConverter(msg[0].timestamp);
	cell2.innerHTML = callID;
	cell3.innerHTML = uuid;
	cell4.innerHTML = "<input type=\"text\" id=\""+uniqueID+"-text\" />";
	cell5.innerHTML = "<button onclick=\"createDefect('"+uniqueID+"')\">Submit Defect</button>";
	
}
function debugMessage()
{
	logMessage(JSON.parse(document.getElementById('testPayload').value));
}

const socket = io({
  reconnectionDelayMax: 10000
});

socket.on('us7 message', function(msg){
    logMessage(msg);
  });
socket.on('us6 message', function(msg){
    logMessage(msg);
  });
  
socket.on('defect submitted', function(msg){
    console.log("defect submitted for" + msg);
  });
socket.on('connect', function() {
		console.log("Connected to websocket");
		if(oldvalue != "")
		{
			console.log("Rejoining: "+ani.value);
			socket.emit('join', ani.value);
		}
	});
  
function getJson() {
  try {
    return jsonObject;
  }catch (ex) {
    alert('Wrong JSON Format: ' + ex);
  }
}

  
  
function createDefect(uniqueID) {
jsonObject = records[uniqueID];
editor.load(getJson());

myModal.show();





return;
var msg = {
board_id:3646541815,
group_id: "topics",
callid:callid,
uuid:records[callid].uuid,
name:document.getElementById(callid+'-text').value,
channel:oldvalue
};

socket.emit('defect', msg);

}


ani.addEventListener("keypress", function(event) {
  // If the user presses the "Enter" key on the keyboard
  if (event.key === "Enter") {
    // Cancel the default action, if needed
    event.preventDefault();
    // Trigger the button element with a click
    assignANI();
  }
});





function assignANI() {
listening.innerHTML = "Listening to: "+ani.value;
listening.classList.add("bg-success");
listening.classList.remove("bg-danger");
console.log("Joining: "+ani.value);
socket.emit('leave', oldvalue);
socket.emit('join', ani.value);
oldvalue = ani.value;
}
	</script>  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    
	
  </body>
</html>