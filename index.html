<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=760">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
	
	

    <title>Five9 UAT Tool</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
 
	<link rel="stylesheet" type="text/css" href="css/custom.css" />











</head>
<body>
	<header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
	  <a class="navbar-brand col-md-2 col-lg-2 me-0 px-3" href="#">Company name</a>
	  <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
		<span class="navbar-toggler-icon"></span>
	  </button>
	  <input class="form-control form-control-dark   " name="ani" id="ani" title="This is the number for the device you are calling from, not the number you are dialing to." type="text" placeholder="Your phone number" aria-label="Search">
	  <div class="navbar-nav col-md-2 col-lg-2">
		<div class="nav-item text-nowrap">
		  <button class="btn btn-dark px-3" onclick="assignANI()" >Assign ANI</button>
		</div>
	  </div>
	</header>

	<div class="row">
		<!--sidebar-->
		<div id="sidebarMenu" class="col-md-2 col-lg-2 d-md-block bg-light sidebar collapse">
			<div class="bg-danger text-white mx-auto text-center" >
				<div id="listening">Not Listening to any ANI</div>
			</div>
			<div id = "debugmenu" class = "collapse">
				<h6>Debug Menu</h6>
				<div class="form-group">
					<label for="testPayload">Payload</label>
					<textarea type="email" class="form-control" id="testPayload" aria-describedby="testPayloadHelp" placeholder="Enter email">
						{
							"group_id": 268,
							"instance_id": 38445,
							"node_type": "start_node",
							"node_values": {
								"XSIP_x_five9ani": "2195521234",
								"XSIP_x_five9callid": "examplecallid"
							},
							"timestamp": "1671069098956",
							"uuid": "example uuid",
							"node_order": 1
						}
					</textarea>
					<small id="testPayloadHelp" class="form-text text-muted">Paste a submission node here.</small>
					<button onclick="debugMessage()" >submit</button>
				</div>
			</div>
		</div>
		
		<!--main table-->
		<main class="col-md-8 ms-sm-auto me-sm-auto col-lg-8 px-md-4">
			<div>
						
						
					
					<table id="logs" class="table" table-striped>
						<tr>
							<th>Time</th>
							<th>CallID</th>
							<th>UUID</th>
							<th>name</th>
							<th>Submit</th>
							</tr>
						<tbody>
						</tbody>
					</table>
			</div>
		</main>
		<div  class="col-md-2 col-lg-2 d-md-block bg-light asside collapse">
		</div>
	</div>
		
		
		
		
		
		
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js" integrity="sha384-/KNQL8Nu5gCHLqwqfQjA689Hhoqgi2S84SNUxC3roTe4EhJ9AfLkp8QiQcU8AMzI" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
<script src="js/jquery.json-editor.js" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js" integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V" crossorigin="anonymous"></script>
<script>
function GetURLParameter(sParam) {
    var sPageURL = window.location.search.substring(1);
    var sURLVariables = sPageURL.split('&');
    for (var i = 0; i < sURLVariables.length; i++) 
    {
        var sParameterName = sURLVariables[i].split('=');
        if (sParameterName[0] == sParam) 
        {
            return sParameterName[1];
        }
    }
	return "null";
}
function timeConverter(UNIX_timestamp){
  var a = new Date(UNIX_timestamp*1);
  return a.toLocaleString('en-US', {
    timeZone: 'America/New_York',
	timeZoneName: 'short'
  });
}
const fullLog = GetURLParameter("fullLog");
const project = GetURLParameter("project");
const debugmenu = document.getElementById('debugmenu');
const ani = document.getElementById('ani');
const logs = document.getElementById('logs');
const listening = document.getElementById('listening');
var oldvalue = "";
var records = {};

if(GetURLParameter("debug") != "null")
{
	new bootstrap.Collapse(debugmenu);
}


function loopLogItem(msg) {
  var callID = (!msg.node_values.XSIP_x_five9callid ) ? "" : msg.node_values.XSIP_x_five9callid;
  var uuid = (!msg.uuid ) ? "" : msg.uuid;
  records[callID+uuid][msg.node_order] = msg;
}

function logMessage(msg)
{
	console.log("Call Information Recieved");
	var callID = (!msg[0].node_values.XSIP_x_five9callid ) ? "" : msg[0].node_values.XSIP_x_five9callid;
	var uuid = (!msg[0].uuid ) ? "" : msg[0].uuid;
	
	if(callID == "" && uuid == "")
	{
		console.log("Invalid call recieved");
		return;
	}
	if (callID+uuid in records)
	{
		msg.forEach(loopLogItem);
		console.log("Call Update");
		return;
	}
	records[callID+uuid] = {};
	msg.forEach(loopLogItem);
	var uniqueID = callID+uuid;
	
	
	
	
	
	console.log(msg);
	var row = logs.insertRow();
	var cell1 = row.insertCell(0);
	var cell2 = row.insertCell(1);
	var cell3 = row.insertCell(2);
	var cell4 = row.insertCell(3);
	var cell5 = row.insertCell(4);
	cell1.innerHTML = timeConverter(msg[0].timestamp);
	cell2.innerHTML = callID;
	cell3.innerHTML = uuid;
	cell4.innerHTML = "<input type=\"text\" id=\""+uniqueID+"-text\" />";
	cell5.innerHTML = "<button onclick=\"createDefect('"+uniqueID+"')\">Submit Defect</button>";
	
}
function debugMessage()
{
	logMessage(JSON.parse(document.getElementById('testPayload').value));
}

const socket = io("wss://test-orelup-aia.ue.r.appspot.com", {
  reconnectionDelayMax: 10000
});

socket.on('chat message', function(msg){
    logMessage(msg);
  });
  
socket.on('defect submitted', function(msg){
    console.log("defect submitted for" + msg);
  });
  

  
  
function createDefect(callid) {
var msg = {
board_id:3646541815,
group_id: "topics",
callid:callid,
uuid:records[callid].uuid,
name:document.getElementById(callid+'-text').value,
channel:oldvalue
};

socket.emit('defect', msg);

}


ani.addEventListener("keypress", function(event) {
  // If the user presses the "Enter" key on the keyboard
  if (event.key === "Enter") {
    // Cancel the default action, if needed
    event.preventDefault();
    // Trigger the button element with a click
    assignANI();
  }
});





function assignANI() {
listening.innerHTML = "Listening to: "+ani.value;
listening.classList.add("bg-success");
listening.classList.remove("bg-danger");
console.log("Joining: "+project+ani.value);
socket.emit('leave', oldvalue);
socket.emit('join', project+ani.value);
oldvalue = project+ani.value;
}
	</script>  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    
	
  </body>
</html>